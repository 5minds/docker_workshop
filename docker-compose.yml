version: "3.7"
services:
    dotnetcore-api:
        image: vega/dotnetcore
        build:
            context: ./dotnetcore/
        volumes: 
            - posts_db:/app/db
        ports: 
            - "5000"
        labels:
            - traefik.enable=true
            - traefik.http.routers.dotnetcore-api.rule=PathPrefix(`/dotnetcore`)
            - traefik.http.routers.dotnetcore-api.middlewares=dotnetcore-api
            - "traefik.http.middlewares.dotnetcore-api.stripprefix.prefixes=/dotnetcore"
            - "traefik.http.routers.myrouter.entrypoints=web"
    frontend:
        image: vega/frontend
        build:
            context: ./frontend/
        ports:
            - "80"
        labels:
            - traefik.enable=true
            - traefik.http.routers.frontend.rule=PathPrefix(`/frontend`)
            - traefik.http.routers.frontend.middlewares=frontend
            - "traefik.http.middlewares.frontend.stripprefix.prefixes=/frontend"
            - "traefik.http.routers.myrouter.entrypoints=web"
    node-api:
        image: vega/node
        build:
            context: ./node/
        ports:
            - "3000"
        labels:
            - traefik.enable=true
            - traefik.http.routers.node.rule=PathPrefix(`/node`)
            - traefik.http.routers.node.middlewares=node
            - "traefik.http.middlewares.node.stripprefix.prefixes=/node"
            - "traefik.http.routers.myrouter.entrypoints=web"
    python-api:
        image: vega/python
        build:
            context: ./python
        ports:
            - "3001"
        labels:
            - traefik.enable=true
            - traefik.http.routers.python.rule=PathPrefix(`/python`)
            - traefik.http.routers.python.middlewares=python
            - "traefik.http.middlewares.python.stripprefix.prefixes=/python"
            - "traefik.http.routers.myrouter.entrypoints=web"
        tty: true
    portainer:
        image: portainer/portainer:latest
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock 
            - portainer_data:/data
        ports:
            - "8000:8000"
            - "9000:9000"
    traefik:
        image: traefik:latest
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
            - ./traefik/traefik.toml:/etc/traefik/traefik.toml
        ports: 
            - "80:80"

volumes:
    posts_db:
    portainer_data:
